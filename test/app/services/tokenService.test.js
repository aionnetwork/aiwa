import sinon from 'sinon';
import Web3 from 'aion-web3';

import _ from 'lodash';
import * as browserService from '../../../app/services/browserService';
import * as tokenService from '../../../app/services/tokenService';
import { convertBNToString } from '../../../app/services/numberFormatter';
import * as mocks from './services.mocks';
import AionWallet from '../../../app/apis/wallet/aionwallet';
import Wallet from '../../../app/apis/wallet/wallet';
// Import Constants
import { CONTRACT_ABI } from '../../../app/constants/tokens';

const assert = require('assert');

const privateKey = '0x336c5c68d75010d738f620fb21a04cc56234d76a7b5d9ca3088708f1c45b3161a75d1c6e59833fad80ba02cc8010c4a99787a0859941613a7ccadf9c51c15c3a';

const account = new Wallet(mocks.defaultWalletsState.wallets.currentWallet.privateKey);
const web3 = new Web3(new Web3.providers.HttpProvider(mocks.networkFullUrl));
const tokenContract = web3.eth.contract(CONTRACT_ABI).at(mocks.newTokenData.address);

describe('#fetchTokenData()', () => {
  it('It should fetch the token data based on token address and network provider', async () => {
    // Initialize Object
    const token = {
      id: 'aiwa3',
      name: 'AIWA3',
      symbol: 'AIWA',
      decimals: '18',
      granularity: '1',
      address: '0xa02210f678afce1cc5ce2eb57b5c6c12186742f71094761d7fbeea38dd3b0495',
    };

    const stubFetchTokenData = sinon.stub(tokenService, 'fetchTokenData').returns({ token });
    const output = await tokenService.fetchTokenData(
      mocks.newTokenData.address,
      mocks.networkFullUrl,
    );
    assert.equal(JSON.stringify(output.token), mocks.tokenData);
    stubFetchTokenData.restore();
  });
});

describe('#fetchTokenBalance()', () => {
  it('It should fetch the token balance based on wallet address token address and network provider', async () => {
    const amount = convertBNToString(0, 0);
    const stubFetchTokenBalance = sinon.stub(tokenService, 'fetchTokenBalance').returns(amount);
    const output = await tokenService.fetchTokenBalance(
      mocks.defaultWalletsState.wallets.currentWallet,
      mocks.newTokenData.address,
      mocks.networkFullUrl,
    );
    assert.equal(
      output,
      mocks.defaultTokensState.tokens.tokenList[
        mocks.defaultWalletsState.wallets.currentWallet.address
      ].mastery[0].balance.amount,
    );
    stubFetchTokenBalance.restore();
  });
  it('It should fetch the AION balance based on wallet address token address and network provider', async () => {
    const amount = 0;
    const stubFetchTokenBalance = sinon.stub(tokenService, 'fetchTokenBalance').returns(amount);
    const output = await tokenService.fetchTokenBalance(
      mocks.defaultWalletsState.wallets.currentWallet,
      'none',
      mocks.networkFullUrl,
    );
    assert.equal(
      output,
      mocks.defaultTokensState.tokens.tokenList[
        mocks.defaultWalletsState.wallets.currentWallet.address
      ].mastery[0].balance.amount,
    );
    stubFetchTokenBalance.restore();
  });
});

describe('#decodeERC777MethodData(data)', () => {
  it('it should able to decode transfer function of token', () => {
    const output = tokenService.decodeERC777MethodData(mocks.transferMethodData);
    assert(
      _.isEqual(output, mocks.transferMethodDecodedOutput),
      'The output should be as expected',
    );
  });
  it('it should able to decode send function of token', () => {
    const output = tokenService.decodeERC777MethodData(mocks.sendMethodData);
    assert(_.isEqual(output, mocks.sendMethodDecodedOutput), 'The output should be as expected');
  });
  it('it should return unknown when unable to decode', () => {
    const output = tokenService.decodeERC777MethodData('0x123456');
    assert(_.isEqual(output, mocks.expectedDefaultOutput), 'The output should be as expected');
  });
});

describe('#isContract(address,provider)', () => {
  it('it should be able to identify address is an account', () => {
    const code = '0x';

    const stubIsContract = sinon.stub(tokenService, 'isContract').returns(code);

    const isAccount = tokenService.isContract(mocks.accountAddress, mocks.networkFullUrl);
    assert.equal(isAccount !== '0x', false, 'Output should be as expected');
    stubIsContract.restore();
  });
  it('it should be able to identify address is a contract', () => {
    const code = '0x605060405236156100f9576000356c01000000000000000000000000900463ffffffff16806306fdde03146100ff578063097c23f81461018f57806318160ddd146101b957806321f3dd65146101e3578063313ce56714610214578063556f0dc7146102445780636f77f29e1461026e57806370a08231146103425780637b78145214610382578063958ec7d1146103e0578063959b8c3f1461042d57806395d89b4114610459578063d0dc2820146104e9578063d95b6371146105ac578063dd62ed3e14610601578063f0a147ad14610652578063f99ef5a5146106ce578063fad8b32a14610739578063fbb001d614610765576100f9565b60006000fd5b341561010b5760006000fd5b6101136107b2565b6040518080601001828103825283818151815260100191508051906010019080838360005b838110156101545780820151818401525b601081019050610138565b50505050905090810190600f1680156101815780820380516001836010036101000a031916815260100191505b509250505060405180910390f35b341561019b5760006000fd5b6101a3610864565b6040518082815260100191505060405180910390f35b34156101c55760006000fd5b6101cd6108a1565b6040518082815260100191505060405180910390f35b34156101ef5760006000fd5b6101f76108b3565b604051808383825281601001526020019250505060405180910390f35b34156102205760006000fd5b6102286108d0565b604051808260ff1660ff16815260100191505060405180910390f35b34156102505760006000fd5b6102586108de565b6040518082815260100191505060405180910390f35b341561027a5760006000fd5b610340600480808060100135903590916020019091929080806010013590359091602001909192908035906010019091908035906010019082018035906010019191908080600f016010809104026010016040519081016040528093929190818152601001838380828437820191505050505050909091908035906010019082018035906010019191908080600f0160108091040260100160405190810160405280939291908181526010018383808284378201915050505050509090919050506108f0565b005b341561034e5760006000fd5b61036c6004808080601001359035909160200190919290505061092f565b6040518082815260100191505060405180910390f35b341561038e5760006000fd5b6103c6600480808060100135903590916020019091929080806010013590359091602001909192908035906010019091905050610960565b604051808215151515815260100191505060405180910390f35b34156103ec5760006000fd5b61041360048080806010013590359091602001909192908035906010019091905050610a8f565b604051808215151515815260100191505060405180910390f35b34156104395760006000fd5b61045760048080806010013590359091602001909192905050610b1e565b005b34156104655760006000fd5b61046d610bbb565b6040518080601001828103825283818151815260100191508051906010019080838360005b838110156104ae5780820151818401525b601081019050610492565b50505050905090810190600f1680156104db5780820380516001836010036101000a031916815260100191505b509250505060405180910390f35b34156104f55760006000fd5b6105aa60048080806010013590359091602001909192908035906010019091908035906010019082018035906010019191908080600f016010809104026010016040519081016040528093929190818152601001838380828437820191505050505050909091908035906010019082018035906010019191908080600f016010809104026010016040519081016040528093929190818152601001838380828437820191505050505050909091905050610c6d565b005b34156105b85760006000fd5b6105e7600480808060100135903590916020019091929080806010013590359091602001909192905050610ca6565b604051808215151515815260100191505060405180910390f35b341561060d5760006000fd5b61063c600480808060100135903590916020019091929080806010013590359091602001909192905050610d11565b6040518082815260100191505060405180910390f35b341561065e5760006000fd5b6106cc60048080806010013590359091602001909192908035906010019091908035906010019082018035906010019191908080600f016010809104026010016040519081016040528093929190818152601001838380828437820191505050505050909091905050610d60565b005b34156106da5760006000fd5b6107376004808035906010019091908035906010019082018035906010019191908080600f016010809104026010016040519081016040528093929190818152601001838380828437820191505050505050909091905050610d91565b005b34156107455760006000fd5b61076360048080806010013590359091602001909192905050610dbc565b005b34156107715760006000fd5b61079860048080806010013590359091602001909192908035906010019091905050610e59565b604051808215151515815260100191505060405180910390f35b6107ba6116d8565b60026000508054600181600116156101000203166002900480600f0160108091040260100160405190810160405280929190818152601001828054600181600116156101000203166002900480156108555780600f1061082857610100808354040283529160100191610855565b8201919060005260106000209050905b81548152906001019060100180831161083857829003600f168201915b50505050509050610861565b90565b600061089761088360066000508060010154905461092f63ffffffff16565b600560005054610ea890919063ffffffff16565b905061089e565b90565b600060056000505490506108b0565b90565b60006000600660005080600101549054915091506108cc565b9091565b6000601290506108db565b90565b600060046000505490506108ed565b90565b610901338989610ca663ffffffff16565b151561090d5760006000fd5b61092533898989898989896001610eca63ffffffff16565b5b50505050505050565b600060086000506000848482528160100152602001908152601001600020905060005054905061095a565b92915050565b6000600a600050600087878252816010015260200190815260100160002090506000506000338252816010015260200190815260100160002090506000505482111515156109ae5760006000fd5b6109fd82600a6000506000898982528160100152602001908152601001600020905060005060003382528160100152602001908152601001600020905060005054610ea890919063ffffffff16565b600a60005060008888825281601001526020019081526010016000209050600050600033825281601001526020019081526010016000209050600050819090905550610a7d338888888888601060405190810160405280600081526010015060106040519081016040528060008152601001506000610eca63ffffffff16565b60019050610a86565b95945050505050565b600081600a600050600033825281601001526020019081526010016000209050600050600086868252816010015260200190815260100160002090506000508190909055508383337f444360fd9f99263247bc59eb6f6c9f5d7f1096ba7962aa22cb94c3f5b743eded876040518082815260100191505060405180910390a360019050610b17565b9392505050565b33838390911491901416151515610b355760006000fd5b600160096000506000848482528160100152602001908152601001600020905060005060003382528160100152602001908152601001600020905060006101000a81548160ff0219169083151502179055503383837ff4caeb2d6ca8932a215a353d0703c326ec2d81fc68170f320eb2ab49e9df61f960405160405180910390a35b5050565b610bc36116d8565b60036000508054600181600116156101000203166002900480600f016010809104026010016040519081016040528092919081815260100182805460018160011615610100020316600290048015610c5e5780600f10610c3157610100808354040283529160100191610c5e565b8201919060005260106000209050905b815481529060010190601001808311610c4157829003600f168201915b50505050509050610c6a565b90565b610c7e338787610ca663ffffffff16565b1515610c8a5760006000fd5b610c9e33878787878761112263ffffffff16565b5b5050505050565b6000828286869091149190141680610d0257506009600050600086868252816010015260200190815260100160002090506000506000848482528160100152602001908152601001600020905060009054906101000a900460ff165b9050610d09565b949350505050565b6000600a6000506000868682528160100152602001908152601001600020905060005060008484825281601001526020019081526010016000209050600050549050610d58565b949350505050565b610d8a33338888888860106040519081016040528060008152601001506001610eca63ffffffff16565b5b50505050565b610db733338686601060405190810160405280600081526010015061112263ffffffff16565b5b5050565b33838390911491901416151515610dd35760006000fd5b600060096000506000848482528160100152602001908152601001600020905060005060003382528160100152602001908152601001600020905060006101000a81548160ff0219169083151502179055503383837f50546e66e5f44d728365dc3908c63bc5cfeeab470722c1677e3073a6ac294aa160405160405180910390a35b5050565b6000610e983333888888601060405190810160405280600081526010015060106040519081016040528060008152601001506000610eca63ffffffff16565b60019050610ea1565b9392505050565b6000828211151515610eba5760006000fd5b8183039050610ec4565b92915050565b610ed98461130863ffffffff16565b60006000878790911491901416151515610ef35760006000fd5b600660005080600101549054878790911491901416151515610f155760006000fd5b83600860005060008a8a8252816010015260200190815260100160002090506000505410151515610f465760006000fd5b610f7a84600860005060008b8b82528160100152602001908152601001600020905060005054610ea890919063ffffffff16565b600860005060008a8a825281601001526020019081526010016000209050600050819090905550610fd5846008600050600089898252816010015260200190815260100160002090506000505461134990919063ffffffff16565b600860005060008888825281601001526020019081526010016000209050600050819090905550858589898d8d7f6565b4df665bcfc14a1b6f57e1795dca4db5db09ae197ee12abddf26cd59a9b08b8b8b604051808481526010018060100180601001838103835285818151815260100191508051906010019080838360005b838110156110715780820151818401525b601081019050611055565b50505050905090810190600f16801561109e5780820380516001836010036101000a031916815260100191505b50838103825284818151815260100191508051906010019080838360005b838110156110d85780820151818401525b6010810190506110bc565b50505050905090810190600f1680156111055780820380516001836010036101000a031916815260100191505b509550505050505060405180910390a45b50505050505050505050565b6111318361130863ffffffff16565b82611142868661092f63ffffffff16565b101515156111505760006000fd5b6111848360086000506000888882528160100152602001908152601001600020905060005054610ea890919063ffffffff16565b6008600050600087878252816010015260200190815260100160002090506000508190909055506111c383600560005054610ea890919063ffffffff16565b60056000508190909055506111e7878787876000600089898961137063ffffffff16565b848488887f01055277133200c3a8bacd68b8d67d1c54154ac94c975287d02eeb1d5f696b12888888604051808481526010018060100180601001838103835285818151815260100191508051906010019080838360005b8381101561125a5780820151818401525b60108101905061123e565b50505050905090810190600f1680156112875780820380516001836010036101000a031916815260100191505b50838103825284818151815260100191508051906010019080838360005b838110156112c15780820151818401525b6010810190506112a5565b50505050905090810190600f1680156112ee5780820380516001836010036101000a031916815260100191505b509550505050505060405180910390a35b50505050505050565b8061133860046000505461132a6004600050548561154190919063ffffffff16565b61156c90919063ffffffff16565b1415156113455760006000fd5b5b50565b6000818301905080508281101515156113625760006000fd5b80905061136a565b92915050565b600060006113ae8989602060405190810160405280600e81526010016f415453546f6b656e53656e64657200008152601001506115af63ffffffff16565b9150915060006000838390911491901416156113c957611534565b8181634e1524c18d8d8d8d8d8d8d8d8d6040518a63ffffffff166c01000000000000000000000000028152600401808a8a825281601001526020018888825281601001526020018686825281601001526020018481526010018060100180601001838103835285818151815260100191508051906010019080838360005b838110156114635780820151818401525b601081019050611447565b50505050905090810190600f1680156114905780820380516001836010036101000a031916815260100191505b50838103825284818151815260100191508051906010019080838360005b838110156114ca5780820151818401525b6010810190506114ae565b50505050905090810190600f1680156114f75780820380516001836010036101000a031916815260100191505b509b5050505050505050505050506000604051808303816000888881813b15156115215760006000fd5b5af1151561152f5760006000fd5b505050505b5050505050505050505050565b60006000821115156115535760006000fd5b818381151561155e57fe5b049050611566565b92915050565b6000600083141561158057600090506115a9565b8183029050805081838281151561159357fe5b041415156115a15760006000fd5b8090506115a9565b92915050565b6000600060006000846040518082805190601001908083835b6010831015156115ee57805182525b6010820191506010810190506010830392506115c8565b6001836010036101000a03801982511681845116808217855250505050505090500191505060405180910390209150915060006000508060010154905463aabbb8ca898986866000604051602001526040518563ffffffff166c01000000000000000000000000028152600401808585825281601001526020018383906000191690906000191690825281601001526020019450505050506020604051808303816000888881813b15156116a25760006000fd5b5af115156116b05760006000fd5b505050506040518080601001519051909160200150935093506116ce565b5050935093915050565b601060405190810160405280600081526010015090565b6005600050546008600050600060066000508060010154905482528160100152602001908152601001600020905060005081909090555060066000508060010154905460056000505460007f7f0c55adb7f69e3decf3ca20f9a2367b205d728e6905eea6c4fb6f3934f842cc60405160405180910390a35b5600a165627a7a72305820c595645ee57ca64843c6677c265bbdd0432aba04528b14f7d2c10a19bd24e38e0029';
    const stubIsContract = sinon.stub(tokenService, 'isContract').returns(code);
    const isContract = tokenService.isContract(
      mocks.contractAddress.toString(),
      mocks.networkFullUrl,
    );
    assert.equal(isContract !== '0x', true, 'Output should be as expected');
    stubIsContract.restore();
  });
});

describe('#getNrgPrice(privateKey)', () => {
  it('Get the gasPrice ', async () => {
    const aionStub = sinon.stub(AionWallet.prototype, 'getGasPrice').returns(mocks.localGasPrice);
    const gasPrice = await tokenService.getNrgPrice(privateKey);
    assert.equal(gasPrice, mocks.localGasPrice, 'Gas price should be as expected');
    aionStub.restore();
  });
});

describe('#sendToken(sendTokenTransaction, contractAddress, privateKey, provider)', () => {
  it('Send Token', async () => {
    const stubSendToken = sinon
      .stub(tokenService, 'sendToken')
      .returns({ account, web3, tokenContract });
    const trxHash = await tokenService.sendToken(
      mocks.sendTokenTransaction,
      mocks.contractAddress,
      privateKey,
      mocks.networkFullUrl,
    );
    assert.equal(trxHash !== undefined, true, 'Send Token Failed');
    stubSendToken.restore();
  });
});

describe('#getNrgLimit(to, amount, data, selectedToken, privateKey, provider)', () => {
  it('Get NRG Limit with contract address and hex data is not given', async () => {
    const stub = sinon.stub(browserService, 'getLocalStorage');
    stub.withArgs('state').returns({ localstate: mocks.localstate });
    const stubMessage = sinon.stub(browserService, 'sendMessage');
    mocks.selectedToken.address = mocks.contractAddress;
    const stubGetNrgLimit = sinon
      .stub(tokenService, 'getNrgLimit')
      .returns({ account, web3, tokenContract });
    const nrgLimit = await tokenService.getNrgLimit(
      mocks.sendTokenTransaction.to,
      mocks.sendTokenTransaction.amount,
      '',
      mocks.selectedToken,
      privateKey,
      mocks.networkFullUrl,
    );
    assert.equal(nrgLimit !== undefined, true, 'Fetching Nrg Limit Failed');
    stubGetNrgLimit.restore();
    stub.restore();
    stubMessage.restore();
  });
  it('Get NRG Limit with contract address and hex data is given', async () => {
    const stub = sinon.stub(browserService, 'getLocalStorage');
    stub.withArgs('state').returns({ localstate: mocks.localstate });
    const stubMessage = sinon.stub(browserService, 'sendMessage');
    mocks.selectedToken.address = mocks.contractAddress;
    const stubGetNrgLimit = sinon
      .stub(tokenService, 'getNrgLimit')
      .returns({ account, web3, tokenContract });
    const nrgLimit = await tokenService.getNrgLimit(
      mocks.sendTokenTransaction.to,
      mocks.sendTokenTransaction.amount,
      '0x1bc',
      mocks.selectedToken,
      privateKey,
      mocks.networkFullUrl,
    );
    assert.equal(nrgLimit !== undefined, true, 'Fetching Nrg Limit Failed');
    stubGetNrgLimit.restore();
    stub.restore();
    stubMessage.restore();
  });
  it('Get NRG Limit with none token', async () => {
    const stub = sinon.stub(browserService, 'getLocalStorage');
    stub.withArgs('state').returns({ localstate: mocks.localstate });
    const stubMessage = sinon.stub(browserService, 'sendMessage');
    const stubGetNrgLimit = sinon
      .stub(tokenService, 'getNrgLimit')
      .returns({ account, web3, tokenContract });
    const nrgLimit = await tokenService.getNrgLimit(
      mocks.sendTokenTransaction.to,
      mocks.sendTokenTransaction.amount,
      '',
      mocks.selectedToken,
      privateKey,
      mocks.networkFullUrl,
    );
    assert.equal(nrgLimit !== undefined, true, 'Fetching Nrg Limit Failed');
    stubGetNrgLimit.restore();
    stub.restore();
    stubMessage.restore();
  });
});
